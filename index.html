<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Avaliações - Online</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --netflix-red: #E50914;
            --netflix-black: #000000;
            --text-color: #ffffff;
            --text-gray: #8c8c8c;
            --input-bg: #222222;
            --status-green: #28a745;
            --status-yellow: #f5c518;
            --status-orange: #e87c03; 
            --edit-blue: #007bff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--netflix-black); color: var(--text-color); font-family: 'Roboto', sans-serif; -webkit-font-smoothing: antialiased; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; padding: 20px 50px; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 10%, rgba(0,0,0,0)); 
            position: fixed; top: 0; left: 0; right: 0; z-index: 100; 
        }
        .logo { font-size: 1.8rem; color: var(--netflix-red); font-weight: 700; text-transform: uppercase; }
        .search-container { flex-grow: 1; text-align: center; }
        #search-input {
            background-color: rgba(0, 0, 0, 0.6); border: 1px solid #444; border-radius: 4px;
            color: var(--text-color); padding: 10px 15px; width: 50%; max-width: 400px;
        }
        .header-buttons button { background-color: var(--netflix-red); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: 700; cursor: pointer; margin-left: 10px; }

        main { padding: 140px 50px 50px 50px; }

        .filter-section {
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            margin-bottom: 50px; background: rgba(255,255,255,0.03); padding: 25px; border-radius: 12px;
        }
        .filter-group { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .filter-label { font-size: 0.75rem; color: var(--text-gray); text-transform: uppercase; font-weight: 900; width: 100%; text-align: center; margin-bottom: 5px; }
        .filter-btn {
            background-color: #1a1a1a; color: var(--text-color); border: 1px solid #333;
            padding: 8px 20px; font-size: 0.85rem; border-radius: 20px; cursor: pointer;
        }
        .filter-btn.active { background-color: white; color: black; font-weight: 700; }

        .reviews-section { margin-bottom: 60px; }
        .reviews-section h2 { font-size: 1.5rem; margin-bottom: 25px; border-left: 4px solid var(--netflix-red); padding-left: 15px; }
        .reviews-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 25px; }

        .poster-card { aspect-ratio: 2 / 3; border-radius: 6px; overflow: hidden; position: relative; cursor: pointer; transition: 0.4s; }
        .poster-card:hover { transform: scale(1.05); box-shadow: 0 15px 30px rgba(0,0,0,0.8); z-index: 10; }
        .poster-card img { width: 100%; height: 100%; object-fit: cover; }
        
        .poster-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,1) 20%, transparent); padding: 20px 12px; opacity: 0; transition: 0.3s; }
        .poster-card:hover .poster-overlay { opacity: 1; }
        .poster-overlay h4 { font-size: 1rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .status-banner { position: absolute; top: 15px; left: -35px; padding: 5px 40px; font-size: 0.6rem; font-weight: 900; transform: rotate(-45deg); z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .in-progress-banner { background-color: var(--status-yellow); color: #000; }
        .finished-banner { background-color: var(--status-green); color: #fff; }
        .abandoned-banner { background-color: var(--status-orange); color: #fff; }
        .favorite-star { position: absolute; top: 10px; right: 10px; font-size: 1.4rem; filter: drop-shadow(0 0 5px black); }

        #details-page { display: none; padding: 120px 50px 50px 50px; min-height: 100vh; }
        .details-container { display: flex; gap: 60px; max-width: 1200px; margin: 0 auto; flex-wrap: wrap; }
        .details-poster { flex: 0 0 350px; }
        .details-poster img { width: 100%; border-radius: 12px; }
        .details-info { flex: 1; min-width: 400px; }
        .details-section-box { background: #111; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #222; }
        .details-section-box h3 { font-size: 0.8rem; text-transform: uppercase; color: var(--netflix-red); margin-bottom: 10px; letter-spacing: 1px; }
        .tech-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #181818; padding: 40px; border-radius: 12px; width: 95%; max-width: 850px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-close-btn { position: absolute; top: 15px; right: 25px; font-size: 2.5rem; color: #666; cursor: pointer; background: none; border: none; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .mb-3 { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-gray); font-size: 0.8rem; text-transform: uppercase; font-weight: 700; }
        .form-control, .form-select { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid #333; color: white; border-radius: 6px; }
        .btn { padding: 14px 28px; border-radius: 4px; cursor: pointer; border: none; font-weight: 700; text-transform: uppercase; transition: 0.2s; margin-right: 10px; }
        .btn-primary { background: var(--netflix-red); color: white; }
        .btn-secondary { background: #333; color: white; }
        .btn-success { background: var(--status-green); color: white; }
        .btn-warning { background: var(--status-yellow); color: black; }
        
        .hidden-field { display: none !important; }
    </style>
</head>
<body>

    <div id="main-content">
        <header>
            <div class="logo">Minhas Avaliações</div>
            <div class="search-container"><input type="search" id="search-input" placeholder="Buscar na nuvem..."></div>
            <div id="header-buttons" class="header-buttons"></div>
        </header>

        <main>
            <div class="filter-section">
                <div id="category-filters" class="filter-group">
                    <span class="filter-label">Filtrar Categoria</span>
                    <button class="filter-btn active" data-filter="all">Tudo</button>
                    <button class="filter-btn" data-filter="Filme">Filmes</button>
                    <button class="filter-btn" data-filter="Série">Séries</button>
                    <button class="filter-btn" data-filter="Desistido">Desistidos</button>
                    <button class="filter-btn" data-filter="Favoritos">Favoritos ⭐</button>
                </div>
                <div id="sort-filters" class="filter-group">
                    <span class="filter-label">Ordenar Visualização</span>
                    <button class="filter-btn active" data-sort="title">Alfabética</button>
                    <button class="filter-btn" data-sort="year-desc">Novos</button>
                    <button class="filter-btn" data-sort="year-asc">Antigos</button>
                    <button class="filter-btn" data-sort="score">Melhor Nota</button>
                </div>
            </div>

            <section class="reviews-section"><h2>Em Andamento</h2><div id="inprogress-grid" class="reviews-grid"></div></section>
            <section class="reviews-section"><h2>Finalizados</h2><div id="finished-grid" class="reviews-grid"></div></section>
            <section class="reviews-section"><h2>Desistidos</h2><div id="abandoned-grid" class="reviews-grid"></div></section>
        </main>
    </div>

    <div id="details-page"></div>
    <div id="modal-backdrop" class="modal-backdrop"><div id="modal-content" class="modal-content"></div></div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCOFjHdo7k6YFHmB-noGFqxOwki5hGbuEM",
    authDomain: "minhas-criticas.firebaseapp.com",
    projectId: "minhas-criticas",
    storageBucket: "minhas-criticas.firebasestorage.app",
    messagingSenderId: "169286670647",
    appId: "1:169286670647:web:805a228ec44a5953b162b2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

document.addEventListener('DOMContentLoaded', function() {
    const ADMIN_LOGIN = 'd_erick96@outlook.com';
    const ADMIN_PASS = '668541230';

    async function loadAndRenderReviews() {
        try {
            const snapshot = await db.collection('avaliacoes').get();
            let reviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const search = document.getElementById('search-input').value.toLowerCase();
            const cat = document.querySelector('#category-filters .active').dataset.filter;
            const sort = document.querySelector('#sort-filters .active').dataset.sort;

            if (search) reviews = reviews.filter(r => r.title.toLowerCase().includes(search));
            if (cat !== 'all') {
                if (cat === 'Favoritos') reviews = reviews.filter(r => r.isFavorite);
                else if (cat === 'Desistido') reviews = reviews.filter(r => r.status === 'abandoned');
                else reviews = reviews.filter(r => r.format === cat);
            }

            reviews.sort((a, b) => {
                if (sort === 'title') return a.title.localeCompare(b.title);
                if (sort === 'year-asc') return parseInt(a.year) - parseInt(b.year);
                if (sort === 'year-desc') return parseInt(b.year) - parseInt(a.year);
                if (sort === 'score') return (parseFloat(b.score) || 0) - (parseFloat(a.score) || 0);
                return 0;
            });

            const draw = (id, list) => {
                const g = document.getElementById(id);
                g.innerHTML = list.length ? '' : '<p style="color:#444; grid-column:1/-1">Nenhum título aqui.</p>';
                list.forEach(r => {
                    const card = document.createElement('div');
                    card.className = 'poster-card';
                    const bannerText = r.status === 'finished' ? 'FINALIZADO' : r.status === 'abandoned' ? 'DESISTIDO' : 'ASSISTINDO';
                    
                    let progressText = '';
                    if (r.status !== 'finished') {
                        progressText = (r.format === 'Série') ? `T${r.season || '?'} E${r.episode || '?'}` : 'Assistindo...';
                    } else {
                        progressText = '★ ' + r.score;
                    }

                    card.innerHTML = `
                        <div class="status-banner ${r.status}-banner">${bannerText}</div>
                        ${r.isFavorite ? '<div class="favorite-star">⭐</div>' : ''}
                        <img src="${r.image}">
                        <div class="poster-overlay">
                            <p style="font-size:0.7rem; color:var(--edit-blue)">${r.format}</p>
                            <h4>${r.title}</h4>
                            <p style="color:var(--status-yellow)">${progressText}</p>
                        </div>`;
                    card.onclick = () => showDetailsPage(r.id, reviews);
                    g.appendChild(card);
                });
            };

            draw('inprogress-grid', reviews.filter(r => r.status === 'in-progress'));
            draw('finished-grid', reviews.filter(r => r.status === 'finished'));
            draw('abandoned-grid', reviews.filter(r => r.status === 'abandoned'));
        } catch (error) {
            console.error("Erro ao carregar dados:", error);
        }
    }

    function showDetailsPage(id, reviews) {
        const r = reviews.find(x => x.id == id);
        const logged = sessionStorage.getItem('isLoggedIn') === 'true';
        document.getElementById('main-content').style.display = 'none';
        const dp = document.getElementById('details-page');
        dp.style.display = 'block';
        window.scrollTo(0,0);

        // Inclusão da Nota no cabeçalho dos detalhes
        const scoreInfo = r.status === 'finished' ? ` • Nota: <span style="color:var(--status-yellow); font-weight:bold;">${r.score}/10</span>` : '';

        dp.innerHTML = `
            <div class="details-container">
                <div class="details-poster"><img src="${r.image}"></div>
                <div class="details-info">
                    <h2>${r.isFavorite ? '⭐ ' : ''}${r.title} (${r.year})</h2>
                    <p style="color:var(--text-gray); margin-bottom:20px">${r.format} • ${r.genre || 'Gênero não informado'}${scoreInfo}</p>
                    <div class="details-section-box"><h3>Lore / Sinopse</h3><p>${r.lore || '-'}</p></div>
                    ${r.status === 'finished' ? `
                        <div class="tech-grid">
                            <div class="details-section-box"><h3>História</h3><p>${r.script || '-'}</p></div>
                            <div class="details-section-box"><h3>Personagens</h3><p>${r.characters || '-'}</p></div>
                            <div class="details-section-box"><h3>Arte/Fotografia</h3><p>${r.cinematography || '-'}</p></div>
                            <div class="details-section-box"><h3>Trilha/Efeitos Sonoros</h3><p>${r.soundtrack || '-'}</p></div>
                            <div class="details-section-box"><h3>VFX/CGI</h3><p>${r.vfx || '-'}</p></div>
                        </div>
                        <div class="details-section-box" style="border-color:#444"><h3>Resumo Final/Crítica</h3><p>${r.comments || '-'}</p></div>
                    ` : `
                        <div class="details-section-box">
                            <h3>Progresso Atual</h3>
                            <p>${r.format === 'Série' ? `Temporada ${r.season || '?'} | Episódio ${r.episode || '?'}` : 'Filme em andamento'}</p>
                        </div>
                    `}
                    <div class="details-actions">
                        <button class="btn btn-secondary" onclick="location.reload()">Voltar</button>
                        ${logged ? `
                            ${r.status === 'in-progress' ? `<button class="btn btn-success" id="finish-btn">Finalizar Obra</button>` : ''}
                            ${r.status === 'abandoned' ? `<button class="btn btn-warning" id="resume-btn">Retomar Obra</button>` : ''}
                            <button class="btn btn-primary" id="e-btn">Editar</button>
                            <button class="btn btn-secondary" style="background:#b20710" id="d-btn">Excluir</button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;

        if(logged) {
            if(document.getElementById('finish-btn')) document.getElementById('finish-btn').onclick = () => showEditModal({review: r, forceFinished: true});
            if(document.getElementById('resume-btn')) document.getElementById('resume-btn').onclick = () => showEditModal({review: r, forceInProgress: true});
            document.getElementById('e-btn').onclick = () => showEditModal({review: r});
            document.getElementById('d-btn').onclick = async () => { if(confirm('Apagar da nuvem?')) { await db.collection('avaliacoes').doc(id).delete(); location.reload(); }};
        }
    }

    function showEditModal({review = null, newStatus = '', forceFinished = false, forceInProgress = false}) {
        let status = review ? review.status : newStatus;
        if (forceFinished) status = 'finished';
        if (forceInProgress) status = 'in-progress';
        const isFin = status === 'finished';

        document.getElementById('modal-content').innerHTML = `
            <button class="modal-close-btn" onclick="document.getElementById('modal-backdrop').style.display='none'">&times;</button>
            <h2 style="margin-bottom:25px">${forceFinished ? 'Finalizar e Avaliar' : (review ? 'Editar Obra' : 'Adicionar à Nuvem')}</h2>
            <form id="r-form">
                <div class="mb-3"><label class="form-label">Capa da Obra</label><input type="file" id="f-img" class="form-control" accept="image/*"></div>
                <div class="form-row">
                    <div><label class="form-label">Título</label><input type="text" id="f-title" class="form-control" value="${review?.title || ''}" required></div>
                    <div><label class="form-label">Ano</label><input type="number" id="f-year" class="form-control" value="${review?.year || ''}" required></div>
                </div>
                <div class="form-row">
                    <div><label class="form-label">Formato</label>
                        <select id="f-format" class="form-select">
                            <option value="Filme" ${review?.format === 'Filme' ? 'selected' : ''}>Filme</option>
                            <option value="Série" ${review?.format === 'Série' ? 'selected' : ''}>Série</option>
                        </select>
                    </div>
                    <div><label class="form-label">Gênero</label><input type="text" id="f-genre" class="form-control" value="${review?.genre || ''}"></div>
                </div>
                <div class="mb-3"><label class="form-label">Lore / Sinopse</label><textarea id="f-lore" class="form-control" rows="2">${review?.lore || ''}</textarea></div>
                
                ${isFin ? `
                    <div class="form-row">
                        <div><label class="form-label">História</label><input type="text" id="f-script" class="form-control" value="${review?.script || ''}"></div>
                        <div><label class="form-label">Personagens</label><input type="text" id="f-char" class="form-control" value="${review?.characters || ''}"></div>
                    </div>
                    <div class="form-row">
                        <div><label class="form-label">Arte/Fotografia</label><input type="text" id="f-cin" class="form-control" value="${review?.cinematography || ''}"></div>
                        <div><label class="form-label">Trilha/Efeitos Sonoros</label><input type="text" id="f-trilha" class="form-control" value="${review?.soundtrack || ''}"></div>
                    </div>
                    <div class="form-row">
                        <div><label class="form-label">VFX/CGI</label><input type="text" id="f-vfx" class="form-control" value="${review?.vfx || ''}"></div>
                        <div><label class="form-label">Nota</label><input type="number" step="0.1" id="f-score" class="form-control" value="${review?.score || ''}" required></div>
                    </div>
                    <div class="mb-3">
                        <label><input type="checkbox" id="f-fav" ${review?.isFavorite ? 'checked' : ''}> Favorito ⭐</label>
                    </div>
                    <div class="mb-3"><label class="form-label">Resumo Final/Crítica</label><textarea id="f-comments" class="form-control" rows="2">${review?.comments || ''}</textarea></div>
                ` : `
                    <div class="form-row" id="series-progress-fields">
                        <div><label class="form-label">Temporada</label><input type="number" id="f-season" class="form-control" value="${review?.season || ''}"></div>
                        <div><label class="form-label">Episódio</label><input type="number" id="f-ep" class="form-control" value="${review?.episode || ''}"></div>
                    </div>
                `}
                <button type="submit" class="btn btn-primary" style="width:100%">Salvar na Nuvem</button>
            </form>
        `;
        document.getElementById('modal-backdrop').style.display='flex';

        const formatSelect = document.getElementById('f-format');
        const progressFields = document.getElementById('series-progress-fields');
        const toggleProgressFields = () => {
            if (progressFields) formatSelect.value === 'Série' ? progressFields.classList.remove('hidden-field') : progressFields.classList.add('hidden-field');
        };
        if (formatSelect) { formatSelect.onchange = toggleProgressFields; toggleProgressFields(); }

        document.getElementById('r-form').onsubmit = async (e) => {
            e.preventDefault();
            let img = review?.image;
            const file = document.getElementById('f-img').files[0];

            if(file) {
                img = await new Promise(res => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const i = new Image();
                        i.onload = () => {
                            const c = document.createElement('canvas');
                            c.width = 400; c.height = (i.height * 400) / i.width;
                            c.getContext('2d').drawImage(i, 0, 0, c.width, c.height);
                            res(c.toDataURL('image/jpeg', 0.8));
                        };
                        i.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            const data = {
                status: status, image: img || '',
                title: document.getElementById('f-title').value,
                year: document.getElementById('f-year').value,
                format: formatSelect.value,
                genre: document.getElementById('f-genre').value,
                lore: document.getElementById('f-lore').value,
                ...(isFin ? {
                    script: document.getElementById('f-script').value,
                    characters: document.getElementById('f-char').value,
                    cinematography: document.getElementById('f-cin').value,
                    soundtrack: document.getElementById('f-trilha').value,
                    vfx: document.getElementById('f-vfx').value,
                    score: document.getElementById('f-score').value,
                    isFavorite: document.getElementById('f-fav').checked,
                    comments: document.getElementById('f-comments').value,
                    season: '', episode: ''
                } : {
                    season: formatSelect.value === 'Série' ? document.getElementById('f-season').value : '',
                    episode: formatSelect.value === 'Série' ? document.getElementById('f-ep').value : '',
                    score: '', isFavorite: false
                })
            };

            try {
                if(review) await db.collection('avaliacoes').doc(review.id).set(data);
                else await db.collection('avaliacoes').add(data);
                location.reload();
            } catch (err) { alert("Erro ao salvar!"); }
        };
    }

    window.updateUI = () => {
        const logged = sessionStorage.getItem('isLoggedIn') === 'true';
        const hb = document.getElementById('header-buttons');
        hb.innerHTML = '';
        if(logged) {
            const b1 = document.createElement('button'); b1.textContent = '+ Adicionar';
            b1.onclick = () => {
                document.getElementById('modal-content').innerHTML = `
                    <button class="modal-close-btn" onclick="document.getElementById('modal-backdrop').style.display='none'">&times;</button>
                    <div style="display:flex; gap:20px; justify-content:center; padding:40px">
                        <button class="btn btn-primary" id="m-prog">Assistindo</button>
                        <button class="btn btn-secondary" id="m-fin">Finalizado</button>
                    </div>`;
                document.getElementById('modal-backdrop').style.display='flex';
                document.getElementById('m-prog').onclick = () => showEditModal({newStatus: 'in-progress'});
                document.getElementById('m-fin').onclick = () => showEditModal({newStatus: 'finished'});
            };
            const b2 = document.createElement('button'); b2.textContent = 'Sair';
            b2.onclick = () => { sessionStorage.removeItem('isLoggedIn'); location.reload(); };
            hb.append(b1, b2);
        } else {
            const b = document.createElement('button'); b.textContent = 'Entrar';
            b.onclick = () => {
                const m = prompt('Email Administrativo:'); const p = prompt('Senha:');
                if(m === ADMIN_LOGIN && p === ADMIN_PASS) { sessionStorage.setItem('isLoggedIn','true'); location.reload(); }
            };
            hb.appendChild(b);
        }
        loadAndRenderReviews();
    };

    document.querySelectorAll('.filter-btn').forEach(b => b.onclick = (e) => {
        e.target.parentNode.querySelector('.active').classList.remove('active');
        e.target.classList.add('active');
        loadAndRenderReviews();
    });
    document.getElementById('search-input').oninput = loadAndRenderReviews;
    updateUI();
});
</script>
</body>
</html>
